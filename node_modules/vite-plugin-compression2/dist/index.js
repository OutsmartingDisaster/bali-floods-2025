"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t,r=require("@rollup/pluginutils"),i=require("fs"),n=require("node:fs/promises"),s=require("os"),o=require("path"),a=require("tar-mini"),l=require("util"),u=require("zlib"),c={exports:{}},p=(e=function(){if(t)return c.exports;t=1;let e,r,i,{defineProperty:n,setPrototypeOf:s,create:o,keys:a}=Object,{round:l,max:u}=Math,p=e=>{let t=/([a-f\d]{3,6})/i.exec(e)?.[1],r=t?.length,i=parseInt(6^r?3^r?"0":t[0]+t[0]+t[1]+t[1]+t[2]+t[2]:t,16);return[i>>16&255,i>>8&255,255&i]},f=(e,t,r)=>e^t||t^r?16+36*l(e/51)+6*l(t/51)+l(r/51):8>e?16:e>248?231:l(24*(e-8)/247)+232,d=e=>{let t,r,i,n,s;return 8>e?30+e:16>e?e-8+90:(232>e?(s=(e-=16)%36,t=(e/36|0)/5,r=(s/6|0)/5,i=s%6/5):t=r=i=(10*(e-232)+8)/255,(n=2*u(t,r,i))?30+(l(i)<<2|l(r)<<1|l(t))+(2^n?0:60):30)},h=(()=>{let t,i,n,s=e=>u.some(t=>e.test(t)),o=globalThis,l=o.process??{},u=l.argv??[],c=l.env??{},p=-1;try{e=","+a(c).join(",")}catch(e){c={},p=0}let f="FORCE_COLOR",d={false:0,0:0,1:1,2:2,3:3}[c[f]]??-1,h=f in c&&d||s(/^--color=?(true|always)?$/);return h&&(p=d),~p||(t=c,i=!!c.PM2_HOME||c.NEXT_RUNTIME?.includes("edge")||!!l.stdout?.isTTY,n="win32"===l.platform,r=t.TERM,p=({"24bit":3,truecolor:3,ansi256:2,ansi:1})[t.COLORTERM]||(t.CI?/,GITHUB/.test(e)?3:1:i&&"dumb"!==r?n?3:/-256/.test(r)?2:1:0)),!d||c.NO_COLOR||s(/^--(no-color|color=(false|never))$/)?0:o.window?.chrome||h&&!p?3:p})(),m={open:"",close:""},g={},y=({p:e},{open:t,close:r})=>{let n=(e,...i)=>{if(!e){if(t&&t===r)return t;if((e??"")==="")return""}let s,o=e.raw?String.raw({raw:e},...i):""+e,a=n.p,l=a.o,u=a.c;if(o.includes("\x1b"))for(;a;a=a.p){let{open:e,close:t}=a,r=t.length,i="",n=0;if(r)for(;~(s=o.indexOf(t,n));n=s+r)i+=o.slice(n,s)+e;o=i+o.slice(n)}return l+(o.includes("\n")?o.replace(/(\r?\n)/g,u+"$1"+l):o)+u},o=t,a=r;return e&&(o=e.o+t,a=r+e.c),s(n,i),n.p={open:t,close:r,o:o,c:a,p:e},n.open=o,n.close=a,n},w=function(e=h){let t={Ansis:w,isSupported:()=>r,strip:e=>e.replace(/[Â›][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g,""),extend(e){for(let t in e){let r=e[t],i=(typeof r)[0],s="s"===i?v(...p(r)):r;g[t]="f"===i?{get(){return(...e)=>y(this,r(...e))}}:{get(){let e=y(this,s);return n(this,t,{value:e}),e}}}return s(t,i=o({},g)),t}},r=e>0,a=(e,t)=>r?{open:`[${e}m`,close:`[${t}m`}:m,l=e=>t=>e(...p(t)),u=(e,t)=>(r,i,n)=>a(`${e}8;2;${r};${i};${n}`,t),c=(e,t)=>(r,i,n)=>a(d(f(r,i,n))+e,t),b=e=>(t,r,i)=>e(f(t,r,i)),v=u(3,39),O=u(4,49),E=e=>a("38;5;"+e,39),j=e=>a("48;5;"+e,49);2===e?(v=b(E),O=b(j)):1===e&&(v=c(0,39),O=c(10,49),E=e=>a(d(e),39),j=e=>a(d(e)+10,49));let x,P={fg:E,bg:j,rgb:v,bgRgb:O,hex:l(v),bgHex:l(O),visible:m,reset:a(0,0),bold:a(1,22),dim:a(2,22),italic:a(3,23),underline:a(4,24),inverse:a(7,27),hidden:a(8,28),strikethrough:a(9,29)},C="Bright";return"black,red,green,yellow,blue,magenta,cyan,white,gray".split(",").map((e,t)=>{x="bg"+e[0].toUpperCase()+e.slice(1),8>t?(P[e+C]=a(90+t,39),P[x+C]=a(100+t,49)):t=60,P[e]=a(30+t,39),P[x]=a(40+t,49)}),t.extend(P)},b=new w;return c.exports=b,b.default=b,c.exports}())&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;const{Ansis:f,fg:d,bg:h,rgb:m,bgRgb:g,hex:y,bgHex:w,reset:b,inverse:v,hidden:O,visible:E,bold:j,dim:x,italic:P,underline:C,strikethrough:R,black:$,red:q,green:z,yellow:S,blue:_,magenta:k,cyan:T,white:A,gray:M,redBright:I,greenBright:B,yellowBright:F,blueBright:N,magentaBright:D,cyanBright:L,whiteBright:U,bgBlack:Z,bgRed:H,bgGreen:Y,bgYellow:Q,bgBlue:X,bgMagenta:G,bgCyan:W,bgWhite:J,bgGray:K,bgRedBright:V,bgGreenBright:ee,bgYellowBright:et,bgBlueBright:er,bgMagentaBright:ei,bgCyanBright:en,bgWhiteBright:es}=p;function eo(e){return e.length}function ea(e){return/^\\\\\?\\/.test(e)?e:e.replace(/\\/g,"/")}async function el(e){let t=await Promise.all((await n.readdir(e)).map(t=>o.join(e,t))),r=0,i=[];for(;r!==eo(t);){let e=t[r],s=await n.stat(e);if(s.isDirectory()){let r=await n.readdir(e);t.push(...r.map(t=>o.join(e,t)))}s.isFile()&&i.push(e),r++}return i}const eu=new TextEncoder;function ec(e){return"string"==typeof e?eu.encode(e):e}function ep(){}function ef(e){return"gz"===e?"gzip":"brotli"===e||"br"===e?"brotliCompress":"zstd"===e?"zstandard":e}async function ed(e,t,r){try{return await t(e,r)}catch(e){return Promise.reject(e)}}const eh={gzip:{level:u.constants.Z_BEST_COMPRESSION},brotliCompress:{params:{[u.constants.BROTLI_PARAM_QUALITY]:u.constants.BROTLI_MAX_QUALITY}},deflate:{level:u.constants.Z_BEST_COMPRESSION},deflateRaw:{level:u.constants.Z_BEST_COMPRESSION},zstandard:{}};function em(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class eg{enqueue(e){this.queue.push(e),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let e=this.queue.shift();this.running++;try{await e()}catch(e){this.errors.push(e)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(e=>setTimeout(e,0));if(eo(this.errors))throw AggregateError(this.errors,"task failed")}constructor(e){em(this,"maxConcurrent",void 0),em(this,"queue",void 0),em(this,"running",void 0),em(this,"errors",void 0),this.maxConcurrent=e,this.queue=[],this.errors=[],this.running=0}}const ey="vite-plugin-compression",ew=(()=>{let e=s.cpus()||{length:1};return 1===e.length?10:Math.max(1,e.length-1)})();function eb(e){var t;let r=new Set,i=(e,t)=>ea(o.resolve(e,t));return(null==(t=e.build.rollupOptions)?void 0:t.output)?(Array.isArray(e.build.rollupOptions.output)?e.build.rollupOptions.output:[e.build.rollupOptions.output]).forEach(t=>{("object"!=typeof t||eo(Object.keys(t)))&&r.add(i(e.root,t.dir||e.build.outDir))}):r.add(i(e.root,e.build.outDir)),r}async function ev(e,t){let r=!("copyPublicDir"in e.build)||e.build.copyPublicDir;if(e.publicDir&&r&&i.existsSync(e.publicDir)){let r=await el(e.publicDir),i=o.join(e.root,o.relative(e.root,e.publicDir));r.forEach(e=>{t(ea(o.relative(i,e)),e)})}}function eO(e,t){if("AggregateError"!==e.name||!("errors"in e))return e;let r=e.errors.length,i=e.errors.map((e,t)=>{let r=e.message||"Unknown error";return`[${t+1}] ${r}`}),n=e.errors.map((e,t)=>{let r=e.stack||e.message||"No stack trace available";return`--- Error ${t+1} ---
${r}`}),s=[`Compression failed in ${t} with ${r} error(s):`,"",...i].join("\n"),o=Error(s);return o.name="CompressionError",o.stack=[`CompressionError: ${s}`,"","Combined stack traces:",...n].join("\n"),o.cause=e.errors,o}function eE(e={}){let t,{include:s=/\.(html|xml|css|json|js|mjs|svg|yaml|yml|toml)$/,exclude:a,threshold:c=0,algorithms:f=["gzip","brotliCompress"],filename:d,deleteOriginalAssets:h=!1,skipIfLargerOrEqual:m=!0,logLevel:g="info"}=e,y=[];f.forEach(e=>{"string"==typeof e?y.push(ej(e)):"object"==typeof e&&Array.isArray(e)&&y.push(e)});let w=r.createFilter(s,a),b=[],v=[],{msgs:O,cleanup:E}=function(){let e=[],t=process.stdout.write.bind(process.stdout);return process.stdout.write=function(...r){let[i]=r,n="string"==typeof i?i:i.toString();return n.includes("built in")?(e.push(n),!1):t.apply(this,r)},{cleanup:()=>process.stdout.write=t,msgs:e}}(),j=process.cwd(),x=y.map(([e,t])=>{let r="string"==typeof e?ef(e):e;return{algorithm:r,algorithmFunction:"string"==typeof r?function(e){let t=ef(e);if("zstandard"===t){let[e,t]=process.versions.node.split(".").map(e=>+e);if(!(e>23||23===e&&t>=8||22===e&&t>=15))throw Error(`Node.js ${process.versions.node} does not support zstd compression. Requires Node.js >= 22.15.0 or >= 23.8.0`);if(!u.zstdCompress)throw Error("zstd compression is not available in this Node.js build");return{algorithm:l.promisify(u.zstdCompress)}}let r=t in u?t:"gzip";return{algorithm:l.promisify(u[r])}}(r).algorithm:r,options:t,filename:null!=d?d:"brotliCompress"===r?"[path][base].br":"zstandard"===r?"[path][base].zst":"[path][base].gz"}}),P=async(e,t,r)=>{let i=eo(e);for(let n=0;n<x.length;n++){let s=x[n],a=n===x.length-1,l=function(e,t,r){let i="function"==typeof t?t(e,r):t,{dir:n,base:s}=o.parse(e);return i.replace(/\[path\]/,n?n+"/":"").replace(/\[base\]/,s)}(t,s.filename,{options:s.options,algorithm:s.algorithm}),u=await ed(e,s.algorithmFunction,s.options);if(m&&eo(u)>=i){r.skip(t);continue}await r.pass(l,a,u)}},C=new eg(ew),R=async function(e,t){for(let e in t){if(!w(e))continue;let r=t[e],i=ec("asset"===r.type?r.source:r.code);eo(i)<c||C.enqueue(async()=>{await P(i,e,{skip:ep,pass:(r,i,n)=>{i&&(h||e===r)&&Reflect.deleteProperty(t,e),this.emitFile({type:"asset",fileName:r,source:n})}})})}await C.wait().catch(e=>{"silent"!==g&&this.error(eO(e,"bundle compression"))})},$={resolve:ep},q={staticOutputs:new Set,done:new Promise(e=>{$.resolve=e})},z=new Intl.NumberFormat("en",{maximumFractionDigits:2,minimumFractionDigits:2}),S=e=>`${z.format(e/1e3)} kB`;return{name:ey,apply:"build",enforce:"post",api:q,async configResolved(e){v.push(...eb(e)),await ev(e,e=>{b.push(e)});let r=e.plugins.find(e=>"vite:build-import-analysis"===e.name);if(!r)throw Error("[vite-plugin-compression] Can't be work in versions lower than vite at 2.0.0");let i=r.generateBundle;if("object"==typeof i&&i.handler){let e=i.handler;i.handler=async function(...t){await e.apply(this,t),await R.apply(this,t)}}"function"==typeof i&&(r.generateBundle=async function(...e){await i.apply(this,e),await R.apply(this,e)}),t=e.logger,j=e.root},async closeBundle(){let r=[],s=async(e,t)=>{let i=o.join(e,t);if(!w(i)&&!q.staticOutputs.has(t))return void q.staticOutputs.add(t);let{size:s}=await n.stat(i);if(s<c){q.staticOutputs.has(t)||q.staticOutputs.add(t);return}let a=await n.readFile(i);await P(a,t,{skip:e=>{q.staticOutputs.has(e)||q.staticOutputs.add(e)},pass:async(t,s,a)=>{q.staticOutputs.has(t)||q.staticOutputs.add(t);let l=o.join(e,t);s&&h&&l!==i&&await n.rm(i,{recursive:!0,force:!0}),await n.writeFile(l,a),r.push({dest:o.relative(j,e)+"/",file:t,size:eo(a)})}})};if(e.artifacts&&"function"==typeof e.artifacts){let t=e.artifacts();for(let e of v)for(let r of t)if(i.existsSync(r.src)){let t=o.basename(r.src),n=r.replace?r.replace(e,t):o.join(e,t);i.cpSync(r.src,n,{recursive:!0}),b.push(ea(o.relative(e,n)))}}for(let e of v)for(let t of b)C.enqueue(()=>s(e,t));if(await C.wait().catch(e=>e),$.resolve(),E(),"silent"!==g&&t){let e=r.reduce((e,t)=>Math.max(e,(t.dest+t.file).length),0);for(let{dest:i,file:n,size:s}of r){let r=n.padEnd(e);t.info(p.dim(i)+p.green(r)+p.bold(p.dim(S(s))))}}for(let e of O)console.info(e)}}}function ej(e,t){if("string"==typeof e){let r=ef(e);if(r in eh){let e={...eh[r]};return t&&Object.assign(e,t),[r,e]}throw Error(`[vite-plugin-compression] Unsupported algorithm: ${e}`)}return[e,t||{}]}eE.getPluginAPI=e=>{var t;return null==(t=e.find(e=>e.name===ey))?void 0:t.api},exports.compression=eE,exports.default=eE,exports.defineAlgorithm=ej,exports.tarball=function(e={}){let t,{dest:r}=e,s=[],l=[],u=[],c=process.cwd(),p=function(){let e=a.createPack(),t=[],r={dests:[],root:""};return{add:t=>{e.add(ec(t.content),{filename:t.filename})},setup:e=>{Object.assign(r,e),r.dests.forEach(e=>{let n=ea(o.resolve(r.root,e+".tar")),s=ea(o.dirname(n));ea(r.root)!==s&&i.mkdirSync(s,{recursive:!0});let a=i.createWriteStream(n);t.push(a)})},done:async()=>{e.done(),await Promise.all(t.map(t=>new Promise((r,i)=>{t.on("error",i),t.on("finish",r),e.receiver.pipe(t)}))),t.length=0}}}(),f=new eg(ew);return{name:"vite-plugin-tarball",enforce:"post",async configResolved(e){l.push(...eb(e)),c=e.root,u=r?[r]:l,(t=eE.getPluginAPI(e.plugins))||await ev(e,e=>{s.push(e)}),p.setup({dests:u,root:c})},writeBundle(e,t){for(let e in t){let r=t[e];p.add({filename:e,content:"asset"===r.type?r.source:r.code})}},async closeBundle(){for(let e of(t&&await t.done,!s.length&&t&&t.staticOutputs.size&&s.push(...t.staticOutputs),l))for(let t of s)f.enqueue(async()=>{let r=o.join(e,t),i=await n.readFile(r);p.add({filename:t,content:i})});await f.wait().catch(e=>{this.error(eO(e,"tarball creation"))}),await p.done()}}};
