import{createFilter as t}from"@rollup/pluginutils";import e from"fs";import r from"node:fs/promises";import i from"os";import n from"path";import{createPack as o}from"tar-mini";import s from"util";import a from"zlib";var l,u,c={exports:{}},p=(l=function(){if(u)return c.exports;u=1;let t,e,r,{defineProperty:i,setPrototypeOf:n,create:o,keys:s}=Object,{round:a,max:l}=Math,p=t=>{let e=/([a-f\d]{3,6})/i.exec(t)?.[1],r=e?.length,i=parseInt(6^r?3^r?"0":e[0]+e[0]+e[1]+e[1]+e[2]+e[2]:e,16);return[i>>16&255,i>>8&255,255&i]},f=(t,e,r)=>t^e||e^r?16+36*a(t/51)+6*a(e/51)+a(r/51):8>t?16:t>248?231:a(24*(t-8)/247)+232,d=t=>{let e,r,i,n,o;return 8>t?30+t:16>t?t-8+90:(232>t?(o=(t-=16)%36,e=(t/36|0)/5,r=(o/6|0)/5,i=o%6/5):e=r=i=(10*(t-232)+8)/255,(n=2*l(e,r,i))?30+(a(i)<<2|a(r)<<1|a(e))+(2^n?0:60):30)},m=(()=>{let r,i,n,o=t=>u.some(e=>t.test(e)),a=globalThis,l=a.process??{},u=l.argv??[],c=l.env??{},p=-1;try{t=","+s(c).join(",")}catch(t){c={},p=0}let f="FORCE_COLOR",d={false:0,0:0,1:1,2:2,3:3}[c[f]]??-1,m=f in c&&d||o(/^--color=?(true|always)?$/);return m&&(p=d),~p||(r=c,i=!!c.PM2_HOME||c.NEXT_RUNTIME?.includes("edge")||!!l.stdout?.isTTY,n="win32"===l.platform,e=r.TERM,p=({"24bit":3,truecolor:3,ansi256:2,ansi:1})[r.COLORTERM]||(r.CI?/,GITHUB/.test(t)?3:1:i&&"dumb"!==e?n?3:/-256/.test(e)?2:1:0)),!d||c.NO_COLOR||o(/^--(no-color|color=(false|never))$/)?0:a.window?.chrome||m&&!p?3:p})(),h={open:"",close:""},g={},y=({p:t},{open:e,close:i})=>{let o=(t,...r)=>{if(!t){if(e&&e===i)return e;if((t??"")==="")return""}let n,s=t.raw?String.raw({raw:t},...r):""+t,a=o.p,l=a.o,u=a.c;if(s.includes("\x1b"))for(;a;a=a.p){let{open:t,close:e}=a,r=e.length,i="",o=0;if(r)for(;~(n=s.indexOf(e,o));o=n+r)i+=s.slice(o,n)+t;s=i+s.slice(o)}return l+(s.includes("\n")?s.replace(/(\r?\n)/g,u+"$1"+l):s)+u},s=e,a=i;return t&&(s=t.o+e,a=i+t.c),n(o,r),o.p={open:e,close:i,o:s,c:a,p:t},o.open=s,o.close=a,o},w=function(t=m){let e={Ansis:w,isSupported:()=>s,strip:t=>t.replace(/[Â›][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g,""),extend(t){for(let e in t){let r=t[e],n=(typeof r)[0],o="s"===n?v(...p(r)):r;g[e]="f"===n?{get(){return(...t)=>y(this,r(...t))}}:{get(){let t=y(this,o);return i(this,e,{value:t}),t}}}return n(e,r=o({},g)),e}},s=t>0,a=(t,e)=>s?{open:`[${t}m`,close:`[${e}m`}:h,l=t=>e=>t(...p(e)),u=(t,e)=>(r,i,n)=>a(`${t}8;2;${r};${i};${n}`,e),c=(t,e)=>(r,i,n)=>a(d(f(r,i,n))+t,e),b=t=>(e,r,i)=>t(f(e,r,i)),v=u(3,39),O=u(4,49),E=t=>a("38;5;"+t,39),j=t=>a("48;5;"+t,49);2===t?(v=b(E),O=b(j)):1===t&&(v=c(0,39),O=c(10,49),E=t=>a(d(t),39),j=t=>a(d(t)+10,49));let x,C={fg:E,bg:j,rgb:v,bgRgb:O,hex:l(v),bgHex:l(O),visible:h,reset:a(0,0),bold:a(1,22),dim:a(2,22),italic:a(3,23),underline:a(4,24),inverse:a(7,27),hidden:a(8,28),strikethrough:a(9,29)},P="Bright";return"black,red,green,yellow,blue,magenta,cyan,white,gray".split(",").map((t,e)=>{x="bg"+t[0].toUpperCase()+t.slice(1),8>e?(C[t+P]=a(90+e,39),C[x+P]=a(100+e,49)):e=60,C[t]=a(30+e,39),C[x]=a(40+e,49)}),e.extend(C)},b=new w;return c.exports=b,b.default=b,c.exports}())&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l;let{Ansis:f,fg:d,bg:m,rgb:h,bgRgb:g,hex:y,bgHex:w,reset:b,inverse:v,hidden:O,visible:E,bold:j,dim:x,italic:C,underline:P,strikethrough:R,black:$,red:z,green:S,yellow:T,blue:k,magenta:A,cyan:_,white:I,gray:M,redBright:B,greenBright:N,yellowBright:q,blueBright:D,magentaBright:F,cyanBright:L,whiteBright:U,bgBlack:Z,bgRed:H,bgGreen:Y,bgYellow:Q,bgBlue:X,bgMagenta:G,bgCyan:W,bgWhite:J,bgGray:K,bgRedBright:V,bgGreenBright:tt,bgYellowBright:te,bgBlueBright:tr,bgMagentaBright:ti,bgCyanBright:tn,bgWhiteBright:to}=p;function ts(t){return t.length}function ta(t){return/^\\\\\?\\/.test(t)?t:t.replace(/\\/g,"/")}async function tl(t){let e=await Promise.all((await r.readdir(t)).map(e=>n.join(t,e))),i=0,o=[];for(;i!==ts(e);){let t=e[i],s=await r.stat(t);if(s.isDirectory()){let i=await r.readdir(t);e.push(...i.map(e=>n.join(t,e)))}s.isFile()&&o.push(t),i++}return o}let tu=new TextEncoder;function tc(t){return"string"==typeof t?tu.encode(t):t}function tp(){}function tf(t){return"gz"===t?"gzip":"brotli"===t||"br"===t?"brotliCompress":"zstd"===t?"zstandard":t}async function td(t,e,r){try{return await e(t,r)}catch(t){return Promise.reject(t)}}let tm={gzip:{level:a.constants.Z_BEST_COMPRESSION},brotliCompress:{params:{[a.constants.BROTLI_PARAM_QUALITY]:a.constants.BROTLI_MAX_QUALITY}},deflate:{level:a.constants.Z_BEST_COMPRESSION},deflateRaw:{level:a.constants.Z_BEST_COMPRESSION},zstandard:{}};function th(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}class tg{enqueue(t){this.queue.push(t),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let t=this.queue.shift();this.running++;try{await t()}catch(t){this.errors.push(t)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(t=>setTimeout(t,0));if(ts(this.errors))throw AggregateError(this.errors,"task failed")}constructor(t){th(this,"maxConcurrent",void 0),th(this,"queue",void 0),th(this,"running",void 0),th(this,"errors",void 0),this.maxConcurrent=t,this.queue=[],this.errors=[],this.running=0}}let ty="vite-plugin-compression",tw=(()=>{let t=i.cpus()||{length:1};return 1===t.length?10:Math.max(1,t.length-1)})();function tb(t){var e;let r=new Set,i=(t,e)=>ta(n.resolve(t,e));return(null==(e=t.build.rollupOptions)?void 0:e.output)?(Array.isArray(t.build.rollupOptions.output)?t.build.rollupOptions.output:[t.build.rollupOptions.output]).forEach(e=>{("object"!=typeof e||ts(Object.keys(e)))&&r.add(i(t.root,e.dir||t.build.outDir))}):r.add(i(t.root,t.build.outDir)),r}async function tv(t,r){let i=!("copyPublicDir"in t.build)||t.build.copyPublicDir;if(t.publicDir&&i&&e.existsSync(t.publicDir)){let e=await tl(t.publicDir),i=n.join(t.root,n.relative(t.root,t.publicDir));e.forEach(t=>{r(ta(n.relative(i,t)),t)})}}function tO(t,e){if("AggregateError"!==t.name||!("errors"in t))return t;let r=t.errors.length,i=t.errors.map((t,e)=>{let r=t.message||"Unknown error";return`[${e+1}] ${r}`}),n=t.errors.map((t,e)=>{let r=t.stack||t.message||"No stack trace available";return`--- Error ${e+1} ---
${r}`}),o=[`Compression failed in ${e} with ${r} error(s):`,"",...i].join("\n"),s=Error(o);return s.name="CompressionError",s.stack=[`CompressionError: ${o}`,"","Combined stack traces:",...n].join("\n"),s.cause=t.errors,s}function tE(t={}){let i,{dest:s}=t,a=[],l=[],u=[],c=process.cwd(),p=function(){let t=o(),r=[],i={dests:[],root:""};return{add:e=>{t.add(tc(e.content),{filename:e.filename})},setup:t=>{Object.assign(i,t),i.dests.forEach(t=>{let o=ta(n.resolve(i.root,t+".tar")),s=ta(n.dirname(o));ta(i.root)!==s&&e.mkdirSync(s,{recursive:!0});let a=e.createWriteStream(o);r.push(a)})},done:async()=>{t.done(),await Promise.all(r.map(e=>new Promise((r,i)=>{e.on("error",i),e.on("finish",r),t.receiver.pipe(e)}))),r.length=0}}}(),f=new tg(tw);return{name:"vite-plugin-tarball",enforce:"post",async configResolved(t){l.push(...tb(t)),c=t.root,u=s?[s]:l,(i=tj.getPluginAPI(t.plugins))||await tv(t,t=>{a.push(t)}),p.setup({dests:u,root:c})},writeBundle(t,e){for(let t in e){let r=e[t];p.add({filename:t,content:"asset"===r.type?r.source:r.code})}},async closeBundle(){for(let t of(i&&await i.done,!a.length&&i&&i.staticOutputs.size&&a.push(...i.staticOutputs),l))for(let e of a)f.enqueue(async()=>{let i=n.join(t,e),o=await r.readFile(i);p.add({filename:e,content:o})});await f.wait().catch(t=>{this.error(tO(t,"tarball creation"))}),await p.done()}}}function tj(i={}){let o,{include:l=/\.(html|xml|css|json|js|mjs|svg|yaml|yml|toml)$/,exclude:u,threshold:c=0,algorithms:f=["gzip","brotliCompress"],filename:d,deleteOriginalAssets:m=!1,skipIfLargerOrEqual:h=!0,logLevel:g="info"}=i,y=[];f.forEach(t=>{"string"==typeof t?y.push(tx(t)):"object"==typeof t&&Array.isArray(t)&&y.push(t)});let w=t(l,u),b=[],v=[],{msgs:O,cleanup:E}=function(){let t=[],e=process.stdout.write.bind(process.stdout);return process.stdout.write=function(...r){let[i]=r,n="string"==typeof i?i:i.toString();return n.includes("built in")?(t.push(n),!1):e.apply(this,r)},{cleanup:()=>process.stdout.write=e,msgs:t}}(),j=process.cwd(),x=y.map(([t,e])=>{let r="string"==typeof t?tf(t):t;return{algorithm:r,algorithmFunction:"string"==typeof r?function(t){let e=tf(t);if("zstandard"===e){let[t,e]=process.versions.node.split(".").map(t=>+t);if(!(t>23||23===t&&e>=8||22===t&&e>=15))throw Error(`Node.js ${process.versions.node} does not support zstd compression. Requires Node.js >= 22.15.0 or >= 23.8.0`);if(!a.zstdCompress)throw Error("zstd compression is not available in this Node.js build");return{algorithm:s.promisify(a.zstdCompress)}}let r=e in a?e:"gzip";return{algorithm:s.promisify(a[r])}}(r).algorithm:r,options:e,filename:null!=d?d:"brotliCompress"===r?"[path][base].br":"zstandard"===r?"[path][base].zst":"[path][base].gz"}}),C=async(t,e,r)=>{let i=ts(t);for(let o=0;o<x.length;o++){let s=x[o],a=o===x.length-1,l=function(t,e,r){let i="function"==typeof e?e(t,r):e,{dir:o,base:s}=n.parse(t);return i.replace(/\[path\]/,o?o+"/":"").replace(/\[base\]/,s)}(e,s.filename,{options:s.options,algorithm:s.algorithm}),u=await td(t,s.algorithmFunction,s.options);if(h&&ts(u)>=i){r.skip(e);continue}await r.pass(l,a,u)}},P=new tg(tw),R=async function(t,e){for(let t in e){if(!w(t))continue;let r=e[t],i=tc("asset"===r.type?r.source:r.code);ts(i)<c||P.enqueue(async()=>{await C(i,t,{skip:tp,pass:(r,i,n)=>{i&&(m||t===r)&&Reflect.deleteProperty(e,t),this.emitFile({type:"asset",fileName:r,source:n})}})})}await P.wait().catch(t=>{"silent"!==g&&this.error(tO(t,"bundle compression"))})},$={resolve:tp},z={staticOutputs:new Set,done:new Promise(t=>{$.resolve=t})},S=new Intl.NumberFormat("en",{maximumFractionDigits:2,minimumFractionDigits:2}),T=t=>`${S.format(t/1e3)} kB`;return{name:ty,apply:"build",enforce:"post",api:z,async configResolved(t){v.push(...tb(t)),await tv(t,t=>{b.push(t)});let e=t.plugins.find(t=>"vite:build-import-analysis"===t.name);if(!e)throw Error("[vite-plugin-compression] Can't be work in versions lower than vite at 2.0.0");let r=e.generateBundle;if("object"==typeof r&&r.handler){let t=r.handler;r.handler=async function(...e){await t.apply(this,e),await R.apply(this,e)}}"function"==typeof r&&(e.generateBundle=async function(...t){await r.apply(this,t),await R.apply(this,t)}),o=t.logger,j=t.root},async closeBundle(){let t=[],s=async(e,i)=>{let o=n.join(e,i);if(!w(o)&&!z.staticOutputs.has(i))return void z.staticOutputs.add(i);let{size:s}=await r.stat(o);if(s<c){z.staticOutputs.has(i)||z.staticOutputs.add(i);return}let a=await r.readFile(o);await C(a,i,{skip:t=>{z.staticOutputs.has(t)||z.staticOutputs.add(t)},pass:async(i,s,a)=>{z.staticOutputs.has(i)||z.staticOutputs.add(i);let l=n.join(e,i);s&&m&&l!==o&&await r.rm(o,{recursive:!0,force:!0}),await r.writeFile(l,a),t.push({dest:n.relative(j,e)+"/",file:i,size:ts(a)})}})};if(i.artifacts&&"function"==typeof i.artifacts){let t=i.artifacts();for(let r of v)for(let i of t)if(e.existsSync(i.src)){let t=n.basename(i.src),o=i.replace?i.replace(r,t):n.join(r,t);e.cpSync(i.src,o,{recursive:!0}),b.push(ta(n.relative(r,o)))}}for(let t of v)for(let e of b)P.enqueue(()=>s(t,e));if(await P.wait().catch(t=>t),$.resolve(),E(),"silent"!==g&&o){let e=t.reduce((t,e)=>Math.max(t,(e.dest+e.file).length),0);for(let{dest:r,file:i,size:n}of t){let t=i.padEnd(e);o.info(p.dim(r)+p.green(t)+p.bold(p.dim(T(n))))}}for(let t of O)console.info(t)}}}function tx(t,e){if("string"==typeof t){let r=tf(t);if(r in tm){let t={...tm[r]};return e&&Object.assign(t,e),[r,t]}throw Error(`[vite-plugin-compression] Unsupported algorithm: ${t}`)}return[t,e||{}]}tj.getPluginAPI=t=>{var e;return null==(e=t.find(t=>t.name===ty))?void 0:e.api};export{tj as compression,tj as default,tx as defineAlgorithm,tE as tarball};
